<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QParadox • Ultracold Gases</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet"/>

<!-- MathJax -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
:root{
  --bg:#0b0b0d; --panel:#131316; --ink:#efeae2; --ink2:#d8d1c8; --muted:#b9b3aa;
  --gold:#caa36b; --blue:#7aa0ff; --line:rgba(255,255,255,.14); --glass:rgba(255,255,255,.06);
  --shadow:0 18px 60px rgba(0,0,0,.72), inset 0 0 120px rgba(255,255,255,.03);
  --radius:18px; --side:330px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family:"Crimson Text",serif; line-height:1.95; letter-spacing:.15px; overflow-x:hidden;
}
body::before{content:""; position:fixed; inset:0; z-index:-3; opacity:.06;
  background:url('https://www.transparenttextures.com/patterns/asfalt-dark.png')}
body::after{content:""; position:fixed; inset:0; z-index:-2; pointer-events:none;
  background:
    radial-gradient(900px 520px at 12% 0%, rgba(180,210,255,.08), transparent 60%),
    radial-gradient(900px 520px at 88% 12%, rgba(140,160,255,.06), transparent 60%),
    radial-gradient(1000px 620px at 50% 100%, rgba(202,163,107,.07), transparent 70%)}

.frame{position:fixed; inset:18px; border:1px solid var(--line); border-radius:22px; pointer-events:none; box-shadow:inset 0 0 140px rgba(0,0,0,.45)}
#progress{position:fixed; top:0; left:0; height:4px; width:0; z-index:100; background:linear-gradient(90deg,var(--gold),var(--blue)); box-shadow:0 0 10px rgba(202,163,107,.6)}

header{padding:6.2rem 1.2rem 2.4rem; text-align:center}
h1{font-family:"Playfair Display",serif; font-weight:900; margin:0;
  font-size:clamp(2.6rem,4vw,4.8rem); line-height:1.1; color:#f5ead8; text-shadow:0 0 22px rgba(255,255,255,.12)}
.subtitle{max-width:980px; margin:1rem auto 0; color:var(--ink2); font-size:clamp(1.05rem,1.2vw,1.2rem)}

.main{width:min(1200px,94%); margin:0 auto 4rem; display:grid; grid-template-columns:1fr; gap:26px}
@media(min-width:1120px){ .main{grid-template-columns:minmax(0, 1fr) var(--side)} }

article{
  background:linear-gradient(180deg,rgba(255,255,255,.055),rgba(255,255,255,.03));
  border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:2.2rem 1.2rem
}
@media(min-width:780px){ article{padding:2.6rem 2.2rem} }
article h2{font-family:"Playfair Display",serif; margin:2rem 0 1rem; font-size:clamp(1.85rem,2.6vw,2.5rem); color:#f6eddc}
.divider{height:1px; background:linear-gradient(90deg,transparent,var(--line),transparent); margin:1.2rem 0}
p{margin:1.05rem 0; text-align:justify}
.dropcap:first-letter{float:left; font-family:"Playfair Display",serif; font-size:3.2rem; line-height:2.3rem; padding:.25rem .5rem .2rem 0; color:#f3e4c5}

/* figure */
.figure{margin:1.5rem auto; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#0e0f12; box-shadow:var(--shadow); max-width:820px}
.figure img{display:block; width:100%; height:auto}
.figcap{padding:.7rem .9rem; color:var(--ink2); font-size:.95rem; border-top:1px solid var(--line)}

/* notes + toc */
.pwrap{position:relative; padding-right:2.5rem}
.hlbtn{position:absolute; right:.2rem; top:.35rem; padding:.25rem .6rem; border-radius:.6rem; background:var(--glass); color:var(--ink); border:1px solid var(--line); font-size:.85rem; cursor:pointer; opacity:0; transition:.2s}
.pwrap:hover .hlbtn{opacity:1}
.mark{background:linear-gradient(180deg, rgba(202,163,107,.3), rgba(122,160,255,.24)); border-radius:.2rem; padding:.05rem .12rem}

aside{position:sticky; top:90px; align-self:start; height:fit-content;
  background:linear-gradient(180deg,rgba(255,255,255,.055),rgba(255,255,255,.03));
  border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:1rem .9rem}
aside h3{margin:.2rem 0 .7rem; font-family:"Playfair Display",serif}
.toc a{display:block; text-decoration:none; color:var(--ink2); padding:.35rem .2rem; border-radius:.4rem; font-size:.95rem}
.toc a:hover{color:var(--ink)}
.toc a.active{color:#111; background:linear-gradient(90deg,var(--gold),#efd6a8)}
hr.sep{border:0; height:1px; background:linear-gradient(90deg,transparent,var(--line),transparent); margin:1rem 0}
.note{border:1px solid var(--line); border-radius:12px; padding:.7rem .75rem; margin:.5rem 0; background:rgba(255,255,255,.05)}
.note time{display:block; color:var(--muted); font-size:.85rem}
.note .del{margin-top:.4rem; padding:.25rem .55rem; border-radius:.5rem; border:1px solid var(--line); background:var(--glass); color:var(--ink); cursor:pointer}

/* quiz */
.quiz{margin-top:1.6rem; padding:1rem; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.04)}
.qitem{margin:1rem 0; padding:.8rem; border-radius:10px; border:1px solid rgba(255,255,255,.12)}
.qitem h4{margin:0 0 .5rem 0; font-family:"Playfair Display",serif}
.qchoices{display:grid; gap:.45rem}
.qchoices button{text-align:left; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.05);
  color:var(--ink); padding:.55rem .7rem; border-radius:.6rem; cursor:pointer}
.qchoices button.correct{border-color:#46d17d}
.qchoices button.wrong{border-color:#e07070}
.qfeedback{color:var(--ink2); margin-top:.4rem; font-size:.98rem}

/* nav row */
.nextrow{display:flex; gap:.6rem; flex-wrap:wrap; margin-top:1.3rem}
.nextrow a{text-decoration:none; color:var(--ink); border:1px solid rgba(255,255,255,.26); border-radius:.8rem;
  background:linear-gradient(90deg,rgba(202,163,107,.28),rgba(122,160,255,.22)); padding:.7rem 1rem}

.reveal{opacity:0; transform:translateY(24px); transition:opacity .9s, transform .9s}
.reveal.in{opacity:1; transform:none}
footer{padding:2rem 1rem; text-align:center; color:var(--muted); border-top:1px solid var(--line)}

/* simulation */
.simcard{max-width:940px; margin:1.2rem auto; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.03); box-shadow:var(--shadow); padding:1rem}
.controls{display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; margin-bottom:.8rem}
.controls label{font-size:.95rem; color:var(--ink2)}
.controls input[type="number"], .controls input[type="range"], .controls select{
  background:rgba(255,255,255,.06); color:var(--ink); border:1px solid var(--line); border-radius:.4rem; padding:.25rem .4rem
}
.controls button{border:1px solid var(--line); background:linear-gradient(90deg,rgba(202,163,107,.28),rgba(122,160,255,.22)); color:var(--ink); padding:.45rem .7rem; border-radius:.6rem; cursor:pointer}
canvas#gas, canvas#plot{display:block; width:100%; height:300px; background:#0e0f12; border:1px solid var(--line); border-radius:.7rem; margin-top:.4rem}
.statrow{display:flex; gap:1rem; flex-wrap:wrap; color:var(--ink2); margin-top:.5rem; font-size:.95rem}
.badge{display:inline-block; padding:.15rem .4rem; border-radius:.35rem; border:1px solid var(--line); background:rgba(255,255,255,.05); margin-left:.25rem}
</style>
</head>
<body>

<div class="frame"></div>
<div id="progress"></div>

<header class="reveal in">
  <h1>Ultracold Gases</h1>
  <p class="subtitle">Condensed atoms for collective quantum behaviors — Bose–Einstein condensates, degenerate Fermi gases, and a cinematic simulation of cooling into quantum order.</p>
</header>

<div class="main">
  <!-- ARTICLE -->
  <article id="article">

    <figure class="figure reveal">
      <img src="ultracold-header.jpeg" alt="Ultracold gases visual"/>
      <figcaption class="figcap">Evaporative cooling and optical traps push dilute gases into regimes where quantum statistics dominate.</figcaption>
    </figure>

    <h2 id="intro" class="reveal">The quantum chill</h2>
    <div class="divider"></div>

    <div class="pwrap reveal">
      <button class="hlbtn" data-target="p1">★ Highlight</button>
      <p id="p1" class="dropcap">
        Laser cooling removes momentum one photon at a time; evaporative cooling lets the hottest atoms escape a trap, lowering temperature further.
        When thermal wavelengths overlap, identity matters: bosons love to share states; fermions refuse. This is the doorway to macroscopic quantum matter.
      </p>
      <p>
        A crude estimate of the critical temperature for an ideal Bose gas at density \(n\) is
        \[
          T_c \approx 0.94\,\frac{\hbar^2}{k_B m}\,n^{2/3}.
        \]
        Below \(T_c\) a macroscopic fraction occupies the ground state — a Bose–Einstein condensate (BEC) with a coherent matter wave.
      </p>
    </div>

    <h2 id="bosons" class="reveal">Bose–Einstein condensation</h2>
    <div class="divider"></div>

    <div class="pwrap reveal">
      <button class="hlbtn" data-target="p2">★ Highlight</button>
      <p id="p2" class="dropcap">
        In a BEC, phase coherence extends across the cloud. Release two condensates and they interfere like laser beams — the signature that the many atoms share one macroscopic wavefunction \(\Psi(\mathbf{r})\).
      </p>
      <p>
        Interactions reshape the density via the Gross–Pitaevskii equation, but the core message survives: cooling bosons reveals order from indistinguishability.
      </p>
    </div>

    <h2 id="fermions" class="reveal">Degenerate Fermi gases</h2>
    <div class="divider"></div>

    <div class="pwrap reveal">
      <button class="hlbtn" data-target="p3">★ Highlight</button>
      <p id="p3" class="dropcap">
        Fermions fill momentum states up to the Fermi energy. Even at zero temperature they exert pressure — Pauli pressure — which keeps the cloud spread out.
        Pairing can turn fermions superfluid (BCS–BEC crossover), but without pairing they never condense into a single mode.
      </p>
    </div>

    <h2 id="sim" class="reveal">Interactive • Cooling into order (Bose vs Fermi)</h2>
    <div class="divider"></div>

    <section class="simcard reveal">
      <p style="color:var(--ink2); margin:.2rem 0 .8rem">
        Thousands of “atoms” drift in a trap. Lower the temperature to slow motion. In Bose mode they merge into a bright coherent core; in Fermi mode they stay spread by Pauli pressure.
        The plot tracks an order parameter: condensed fraction for bosons, degeneracy parameter for fermions.
      </p>

      <div class="controls">
        <label>Mode:
          <select id="mode">
            <option value="bose">Bose (BEC)</option>
            <option value="fermi">Fermi (degenerate)</option>
          </select>
        </label>
        <label>Atoms: <input id="N" type="number" min="200" max="4000" value="1600"/></label>
        <label>Temperature: <input id="T" type="range" min="0" max="1" step="0.01" value="0.55"/></label>
        <span id="Tval" class="badge">0.55</span>
        <label>Trap strength: <input id="ktrap" type="range" min="0.2" max="4" step="0.1" value="1.6"/></label>
        <span id="ktrapVal" class="badge">1.6</span>
        <button id="seed">Reseed Cloud</button>
        <button id="cool">Cool (–0.05)</button>
        <button id="heat">Heat (+0.05)</button>
        <button id="reset">Reset</button>
      </div>

      <canvas id="gas" width="980" height="300"></canvas>
      <div class="statrow">
        <div>Order parameter: <span id="order" class="badge">—</span></div>
        <div>Core size (px): <span id="coresize" class="badge">—</span></div>
        <div>RMS radius (px): <span id="rms" class="badge">—</span></div>
      </div>
      <canvas id="plot" width="980" height="300"></canvas>
    </section>

    <h2 id="apps" class="reveal">Coherence, superfluidity, & uses</h2>
    <div class="divider"></div>

    <div class="pwrap reveal">
      <button class="hlbtn" data-target="p4">★ Highlight</button>
      <p id="p4" class="dropcap">
        Ultracold gases provide pristine platforms for analog quantum simulation (Hubbard models), precision metrology (atom interferometers, clocks), and tests of many-body dynamics (quenches, transport, universality).
        They also serve as clean laboratories for superfluidity, vortices, and sound in quantum fluids.
      </p>
    </div>

    <h2 id="quiz" class="reveal">Quick Quiz – Ultracold Gases</h2>
    <div class="divider"></div>

    <section class="quiz reveal" id="quizSection">
      <div class="qitem">
        <h4>1) A Bose–Einstein condensate forms when</h4>
        <div class="qchoices" data-answer="b" data-explain="Thermal de Broglie wavelengths overlap and a macroscopic fraction occupies the ground state.">
          <button data-choice="a">pressure becomes very high</button>
          <button data-choice="b">temperature drops below \(T_c\) so many bosons share one mode</button>
          <button data-choice="c">atoms crystallize</button>
        </div>
        <div class="qfeedback"></div>
      </div>

      <div class="qitem">
        <h4>2) Pauli pressure in a Fermi gas arises because</h4>
        <div class="qchoices" data-answer="a" data-explain="No two identical fermions occupy the same quantum state.">
          <button data-choice="a">exclusion principle fills momentum states</button>
          <button data-choice="b">van der Waals attraction is strong</button>
          <button data-choice="c">the trap is anharmonic</button>
        </div>
        <div class="qfeedback"></div>
      </div>

      <div class="qitem">
        <h4>3) Interference fringes from two BECs indicate</h4>
        <div class="qchoices" data-answer="c" data-explain="A well-defined relative phase — macroscopic coherence.">
          <button data-choice="a">strong interactions only</button>
          <button data-choice="b">thermalization</button>
          <button data-choice="c">phase coherence across many atoms</button>
        </div>
        <div class="qfeedback"></div>
      </div>

      <div class="qitem">
        <h4>4) Decreasing the temperature in the simulation should</h4>
        <div class="qchoices" data-answer="b" data-explain="Lower speeds; in Bose mode the core brightens and the condensed fraction rises.">
          <button data-choice="a">increase atom speeds</button>
          <button data-choice="b">decrease speeds and increase order</button>
          <button data-choice="c">leave motion unchanged</button>
        </div>
        <div class="qfeedback"></div>
      </div>

      <div class="qitem">
        <h4>5) At fixed atom number, strengthening the trap (higher spring k)</h4>
        <div class="qchoices" data-answer="a" data-explain="A stronger harmonic trap shrinks the cloud (smaller RMS radius).">
          <button data-choice="a">shrinks the cloud’s RMS radius</button>
          <button data-choice="b">expands the cloud</button>
          <button data-choice="c">has no effect</button>
        </div>
        <div class="qfeedback"></div>
      </div>
    </section>

    <div class="nextrow reveal">
      <a href="rydberg-atoms.html">← Back to Rydberg Atoms</a>
      <a href="experimental.html">Back to Experimental Hub →</a>
    </div>

  </article>

  <!-- SIDEBAR -->
  <aside class="reveal">
    <h3>Contents</h3>
    <div id="toc" class="toc"></div>
    <hr class="sep"/>
    <h3>Notebook</h3>
    <p style="color:var(--ink2); margin:.1rem 0 .6rem">Click ★ to save paragraphs here. You can also write your own notes below.</p>
    <div id="nbList"></div>
    <textarea id="freeNote" placeholder="Write your own note..." style="margin-top:.6rem; height:100px; background:rgba(255,255,255,.05); border:1px solid var(--line); color:var(--ink); border-radius:.5rem; padding:.55rem .6rem; font-family:'Crimson Text',serif;"></textarea>
    <div style="display:flex; gap:.5rem; margin-top:.4rem">
      <button id="saveFree" style="padding:.45rem .7rem; border-radius:.6rem; border:1px solid var(--line); background:var(--glass); color:var(--ink); cursor:pointer">Save</button>
      <button id="clearAll" style="padding:.45rem .7rem; border-radius:.6rem; border:1px solid var(--line); background:var(--glass); color:var(--ink); cursor:pointer">Clear all</button>
    </div>
    <p style="color:var(--muted); font-size:.9rem; margin-top:.4rem">Notes are stored locally in your browser.</p>
  </aside>
</div>

<footer>© 2025 QParadox</footer>

<script>
/* ===== Progress bar ===== */
const bar=document.getElementById('progress');
function onScroll(){const h=document.documentElement,st=h.scrollTop||document.body.scrollTop,sh=h.scrollHeight-h.clientHeight;
  bar.style.width=(Math.max(0,Math.min(1,st/sh))*100)+'%';}
addEventListener('scroll',onScroll);onScroll();

/* ===== Reveal on scroll ===== */
const obs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting){e.target.classList.add('in');obs.unobserve(e.target);}})},{threshold:.18});
document.querySelectorAll('.reveal').forEach(el=>{if(!el.classList.contains('in'))obs.observe(el);});

/* ===== TOC ===== */
const toc=document.getElementById('toc');const heads=[...document.querySelectorAll('#article h2')];
heads.forEach(h=>{const a=document.createElement('a');a.href='#'+h.id;a.textContent=h.textContent;toc.appendChild(a);});
function spy(){const y=scrollY+140;let idx=-1;heads.forEach((s,i)=>{if(s.offsetTop<=y&&s.offsetTop+s.offsetHeight>y)idx=i;});
[...toc.querySelectorAll('a')].forEach((a,i)=>a.classList.toggle('active',i===idx));}
addEventListener('scroll',spy);spy();

/* ===== Notebook ===== */
const KEY='qpx_notes_lagrangian_v1';const listEl=document.getElementById('nbList');
function load(){try{return JSON.parse(localStorage.getItem(KEY)||'[]');}catch(e){return [];} }
function save(data){localStorage.setItem(KEY,JSON.stringify(data));}
function render(){const notes=load();listEl.innerHTML='';
  if(notes.length===0){listEl.innerHTML='<p style="color:var(--muted)">No notes yet.</p>';return;}
  notes.forEach(n=>{const div=document.createElement('div');div.className='note';div.dataset.id=n.id;
    div.innerHTML=`<time>${new Date(n.time).toLocaleString()}</time><p>${n.text}</p><button class="del">Remove</button>`;
    listEl.appendChild(div);});}
render();
document.querySelectorAll('.hlbtn').forEach(btn=>{btn.addEventListener('click',()=>{const id=btn.dataset.target,p=document.getElementById(id);
  if(!p)return;p.classList.add('mark');const notes=load();notes.push({id:'n'+Date.now(),text:p.textContent.trim(),time:Date.now(),para:id});
  save(notes);render();});});
document.getElementById('saveFree').addEventListener('click',()=>{const box=document.getElementById('freeNote');const t=box.value.trim();if(!t)return;
  const notes=load();notes.push({id:'n'+Date.now(),text:t,time:Date.now(),para:null});save(notes);render();box.value='';});
listEl.addEventListener('click',e=>{if(!e.target.classList.contains('del'))return;const item=e.target.closest('.note');const id=item.dataset.id;
  const notes=load().filter(x=>x.id!==id);save(notes);render();});
document.getElementById('clearAll').addEventListener('click',()=>{if(!confirm('Clear all notes?'))return;localStorage.removeItem(KEY);render();
  document.querySelectorAll('.mark').forEach(m=>m.classList.remove('mark'));});

/* ===== Quiz grading ===== */
document.querySelectorAll('.qchoices').forEach(group=>{
  group.addEventListener('click',e=>{
    if(e.target.tagName!=='BUTTON') return;
    const answer = group.dataset.answer;
    const fb = group.parentElement.querySelector('.qfeedback');
    group.querySelectorAll('button').forEach(b=>{ b.disabled = true; b.classList.remove('correct','wrong'); });
    if(e.target.dataset.choice === answer){
      e.target.classList.add('correct'); fb.textContent = 'Correct — ' + group.dataset.explain; fb.style.color = '#8fe0a8';
    }else{
      e.target.classList.add('wrong'); const right = [...group.querySelectorAll('button')].find(b=>b.dataset.choice===answer);
      if(right) right.classList.add('correct'); fb.textContent = 'Wrong — ' + group.dataset.explain; fb.style.color = '#f29b9b';
    }
  });
});

/* ===== Ultracold gas simulator (Bose/Fermi) ===== */
const gas=document.getElementById('gas'), gtx=gas.getContext('2d');
const plot=document.getElementById('plot'), ptx=plot.getContext('2d');

let MODE='bose'; // 'bose' or 'fermi'
let N=1600, T=0.55, KTRAP=1.6;
let atoms=[], trace=[];
const W=gas.width, H=gas.height, cx=W/2, cy=H/2;

function rnd(a,b){return a+Math.random()*(b-a);}
function reseed(){
  atoms.length=0; trace.length=0;
  for(let i=0;i<N;i++){
    const ang=Math.random()*Math.PI*2;
    const r=Math.sqrt(Math.random())*Math.min(W,H)*0.35;
    const x=cx+r*Math.cos(ang), y=cy+r*Math.sin(ang);
    // velocities scale with sqrt(T)
    const vscale=Math.sqrt(T)*2.2;
    atoms.push({x,y,vx:rnd(-vscale,vscale),vy:rnd(-vscale,vscale)});
  }
}
function step(){
  // harmonic trap + thermal kicks; Bose adds attraction to center as T -> 0; Fermi adds weak repulsion
  const bosonAttract = MODE==='bose' ? (1.0 - Math.min(1,T)) * 0.02 : 0;
  const fermiRepulse  = MODE==='fermi' ? (1.0 - Math.min(1,T)) * 0.7 : 0;

  // simple grid for repulsion (avoid O(N^2))
  const cell=24, cols=Math.ceil(W/cell), rows=Math.ceil(H/cell);
  const grid=Array.from({length:cols*rows},()=>[]);
  function cellIndex(x,y){ return Math.max(0,Math.min(cols-1,Math.floor(x/cell))) + cols*Math.max(0,Math.min(rows-1,Math.floor(y/cell))); }
  atoms.forEach((a,i)=>{ grid[cellIndex(a.x,a.y)].push(i); });

  for(let i=0;i<N;i++){
    const a=atoms[i];
    // harmonic force
    const dx=a.x-cx, dy=a.y-cy;
    a.vx += -KTRAP*dx*0.0008;
    a.vy += -KTRAP*dy*0.0008;

    // boson "coherence pull"
    if(bosonAttract>0){ a.vx += -dx*bosonAttract; a.vy += -dy*bosonAttract; }

    // fermi repulsion via nearby neighbors
    if(fermiRepulse>0){
      const cxi=Math.max(0,Math.min(cols-1,Math.floor(a.x/cell)));
      const cyi=Math.max(0,Math.min(rows-1,Math.floor(a.y/cell)));
      for(let yy=cyi-1; yy<=cyi+1; yy++){
        for(let xx=cxi-1; xx<=cxi+1; xx++){
          if(xx<0||yy<0||xx>=cols||yy>=rows) continue;
          for(const j of grid[xx+cols*yy]){
            if(j===i) continue;
            const b=atoms[j], rx=a.x-b.x, ry=a.y-b.y, r2=rx*rx+ry*ry;
            if(r2<200){ // short-range softness
              const inv=1/Math.max(8, r2);
              a.vx += rx*inv*fermiRepulse*0.6;
              a.vy += ry*inv*fermiRepulse*0.6;
            }
          }
        }
      }
    }

    // thermal noise
    const kick=(Math.random()-0.5)*0.05*Math.sqrt(T);
    a.vx += kick; a.vy += -kick;

    // integrate + gentle damping
    a.x += a.vx; a.y += a.vy;
    a.vx *= 0.995; a.vy *= 0.995;
  }
}
function measure(){
  // core size ~ radius enclosing central 30% density; condensed fraction ~ weight near center
  let rsum=0;
  let near=0;
  for(const a of atoms){
    const dx=a.x-cx, dy=a.y-cy, r=Math.hypot(dx,dy);
    rsum += r;
    if(r<40) near++;
  }
  const rms = (rsum/N).toFixed(1);
  let order;
  if(MODE==='bose'){
    // map near-center population to condensed fraction proxy
    order = Math.min(1, near/(N*0.18));
  }else{
    // degeneracy parameter proxy: small RMS radius => higher degeneracy, but Fermi spreads, so invert
    order = Math.max(0, 1 - Math.min(1, (rsum/N)/150 ));
  }
  document.getElementById('rms').textContent = rms+' px';
  document.getElementById('coresize').textContent = (near).toString();
  document.getElementById('order').textContent = order.toFixed(2);
  trace.push({t:performance.now()/1000, y:order});
  if(trace.length>800) trace.shift();
}
function draw(){
  gtx.clearRect(0,0,W,H);
  // soft background grid
  gtx.strokeStyle='rgba(255,255,255,.06)';
  gtx.beginPath(); gtx.arc(cx,cy,40,0,Math.PI*2); gtx.stroke();

  // atoms with cinematic glow
  const now=performance.now()/1000;
  for(const a of atoms){
    const speed=Math.hypot(a.vx,a.vy);
    const glow=MODE==='bose'
      ? (0.25+0.7*(1-Math.min(1,T)))  // brighter as colder
      : (0.18+0.3*Math.min(1,T));     // dimmer as colder (stays granular)

    const grad=gtx.createRadialGradient(a.x,a.y,0,a.x,a.y,10+6*Math.sin(now*2));
    if(MODE==='bose' && T<0.35){
      grad.addColorStop(0,'rgba(255,235,180,'+(0.6+glow*0.6)+')');
      grad.addColorStop(1,'rgba(255,235,180,0)');
    }else{
      grad.addColorStop(0,'rgba(160,190,255,'+(0.35+glow*0.4)+')');
      grad.addColorStop(1,'rgba(160,190,255,0)');
    }
    gtx.fillStyle=grad; gtx.beginPath(); gtx.arc(a.x,a.y, 3.2+speed*0.3,0,Math.PI*2); gtx.fill();

    // core dot
    gtx.fillStyle = (MODE==='bose' && T<0.35) ? '#ffe6b0' : '#cfd8ff';
    gtx.beginPath(); gtx.arc(a.x,a.y,1.1,0,Math.PI*2); gtx.fill();
  }
}
function drawPlot(){
  ptx.clearRect(0,0,plot.width,plot.height);
  ptx.strokeStyle='rgba(255,255,255,.2)'; ptx.beginPath(); ptx.moveTo(50,20); ptx.lineTo(50,260); ptx.lineTo(940,260); ptx.stroke();
  ptx.fillStyle='#d8d1c8'; ptx.font='14px "Crimson Text",serif';
  ptx.fillText(MODE==='bose'?'condensed fraction':'degeneracy proxy', 10, 30);
  ptx.fillText('time', 890, 280);
  if(trace.length<2) return;
  const t0=trace[0].t, t1=trace[trace.length-1].t, span=Math.max(1,t1-t0);
  ptx.strokeStyle='rgba(202,163,107,.9)';
  ptx.beginPath();
  ptx.moveTo(50, 260-(trace[0].y*220));
  for(const pt of trace){
    const x=50 + (pt.t-t0)/span * 890;
    const y=260 - pt.y*220;
    ptx.lineTo(x,y);
  }
  ptx.stroke();
}

function loop(){
  step(); measure(); draw(); drawPlot();
  requestAnimationFrame(loop);
}

/* ===== Controls ===== */
function reseedAndUpdate(){ reseed(); draw(); drawPlot(); }
document.getElementById('mode').addEventListener('change',e=>{MODE=e.target.value; trace.length=0;});
document.getElementById('N').addEventListener('change',e=>{N=parseInt(e.target.value,10)||1600; reseedAndUpdate();});
document.getElementById('T').addEventListener('input',e=>{T=parseFloat(e.target.value); document.getElementById('Tval').textContent=T.toFixed(2);});
document.getElementById('ktrap').addEventListener('input',e=>{KTRAP=parseFloat(e.target.value); document.getElementById('ktrapVal').textContent=KTRAP.toFixed(1);});
document.getElementById('seed').addEventListener('click',reseedAndUpdate);
document.getElementById('cool').addEventListener('click',()=>{T=Math.max(0,T-0.05); document.getElementById('T').value=T; document.getElementById('Tval').textContent=T.toFixed(2);});
document.getElementById('heat').addEventListener('click',()=>{T=Math.min(1,T+0.05); document.getElementById('T').value=T; document.getElementById('Tval').textContent=T.toFixed(2);});
document.getElementById('reset').addEventListener('click',()=>{MODE='bose'; document.getElementById('mode').value='bose'; N=1600; T=0.55; KTRAP=1.6;
  document.getElementById('N').value=N; document.getElementById('T').value=T; document.getElementById('Tval').textContent=T.toFixed(2);
  document.getElementById('ktrap').value=KTRAP; document.getElementById('ktrapVal').textContent=KTRAP.toFixed(1);
  reseedAndUpdate();});

reseed(); loop();
</script>
</body>
</html>
